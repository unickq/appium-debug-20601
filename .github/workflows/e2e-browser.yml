name: E2E - Browser Tests

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Select platform to build"
        required: true
        default: "android"
        type: choice
        options:
          - all
          - ios
          - android
  pull_request:
    branches:
      - main

jobs:
  iOS-browser:
    if: ${{ github.event_name == 'pull_request' || github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios' }}
    runs-on: macos-14
    timeout-minutes: 15
    # https://github.com/futureware-tech/simulator-action/wiki/Devices-macos-14
    env:
      ios_model: "iPhone 15"
      ios_version: "17.5"
      xcode_version: "15.4"
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
      - name: üß© Install Dependencies
        run: npm ci
      - name: üîß Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.xcode_version }}
      - name: üì± Start iOS Device
        uses: futureware-tech/simulator-action@v3
        with:
          model: ${{ env.ios_model }}
          os_version: ${{ env.ios_version }}
      - name: üîß Prebuild XCUITest driver
        run: |
          npx appium driver run xcuitest build-wda --sdk=${{ env.ios_version }} --name="${{ env.ios_model }}"
          # xcodebuild build-for-testing test-without-building -project /Users/runner/work/appium-debug-20601/appium-debug-20601/node_modules/appium-xcuitest-driver/node_modules/appium-webdriveragent/WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -derivedDataPath /Users/runner/Library/Developer/Xcode/DerivedData/WebDriverAgent-fxpboqmophaxtkbachmlyekqopep -destination id=B2E5D5A9-E7EC-46B0-B64D-9FC0DBBA441B IPHONEOS_DEPLOYMENT_TARGET=17.5 GCC_TREAT_WARNINGS_AS_ERRORS=0 COMPILER_INDEX_STORE_ENABLE=NO
      - name: üîß Run Appium
        run: |
          npx appium --log-timestamp --log logs/appium-ios.log --log-level debug &
      - name: üß™ Run tests iOS emulator
        run: |
          node pure.cjs
      - name: üíæ Save Appium server output
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-runner-output
          path: |
            logs/
